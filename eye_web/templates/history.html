<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CataractGPT - Scan History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="{{ url_for('static', filename='history.css') }}">
</head>

<body class="theme-lab">
<div class="bg-grid" aria-hidden="true"></div>
<div class="scanline" aria-hidden="true"></div>

<div class="app">
    <aside class="sidebar">
        <div class="sidebar-head">
            <div class="brand">CataractGPT</div>
            <div class="brand-sub">Scan Lab Console</div>
        </div>

        <nav class="side-nav">
            <a class="nav-item" href="/">New Analysis</a>
            <a class="nav-item active" href="/history">History</a>
            <a class="nav-item" href="/protocols">Research Protocols</a>
            <a class="nav-item" href="/settings">System Settings</a>
        </nav>

        <div class="sidebar-foot">
            <div class="status-dot"></div>
            <div>
                <div class="status-title">System Status: Online</div>
                <div class="status-sub">Region: GCP-East-1</div>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="topbar app-header">
            <div class="topbar-left">
                <div class="topbar-title">Scan History</div>
                <div class="topbar-sub">Review past AI screenings</div>
            </div>
            <div class="topbar-right">
                <a href="/" class="btn btn-secondary">Back to New Analysis</a>
            </div>
        </header>

        <main class="main-content">
            <div class="history-layout">
                <div class="history-col">
                    <section class="panel history-detail history-insights">
                        <div class="panel-header">
                            <h2>Session Insights</h2>
                            <span class="panel-sub">Summary</span>
                        </div>

                        <div class="insight-row">
                            <span>Total scans</span>
                            <strong>{{ history|length }}</strong>
                        </div>

                        <div class="insight-row">
                            <span>Normal screenings</span>
                            <strong>{{ history | selectattr("prediction","equalto","Normal") | list | length }}</strong>
                        </div>

                        <div class="insight-row">
                            <span>Cataract screenings</span>
                            <strong>{{ history | selectattr("prediction","equalto","Cataract") | list | length }}</strong>
                        </div>

                        <div class="chart-wrap">
                            <canvas id="confidenceChart"></canvas>
                        </div>

                        <div class="panel-header">
                            <h2>Session Tools</h2>
                            <span class="panel-sub">Controls</span>
                        </div>

                        <div class="tool-grid">
                            <button class="btn btn-secondary" id="demoModeBtn" type="button">Demo Mode</button>
                            <button class="btn btn-secondary" id="compactModeBtn" type="button">Compact Layout</button>
                            <button class="btn btn-secondary" id="resetSessionBtn" type="button">Reset Session</button>
                        </div>

                        <form action="{{ url_for('clear_history') }}" method="POST">
                            <button class="btn btn-danger">Clear All History</button>
                        </form>
                    </section>

                    <section class="panel history-detail history-selected" id="detailPanel">
                        <div class="panel-header">
                            <h2>Selected Scan</h2>
                            <span class="panel-sub">Inspection</span>
                        </div>

                        <div class="detail-image-wrapper" id="detailImageWrapper">
                            <img id="detailImage" class="detail-image" alt="Selected eye scan">

                            <div class="comparison-row">
                                <img id="compareImage" class="detail-image" alt="Comparison scan">
                            </div>

                            <div class="detail-placeholder" id="detailPlaceholder">
                                <div class="placeholder-icon">[scan]</div>
                                <p>Select a scan from history to review AI screening results</p>
                            </div>
                        </div>

                        <div class="detail-row">
                            <span>AI screening result</span>
                            <strong id="detailPrediction">--</strong>
                        </div>

                        <div class="detail-row">
                            <span>Model confidence</span>
                            <strong id="detailConfidence">--</strong>
                        </div>

                        <div class="detail-row">
                            <span>Date and time</span>
                            <span id="detailTime">--</span>
                        </div>

                        <div class="detail-row">
                            <span>Severity</span>
                            <span id="detailSeverity">--</span>
                        </div>

                        <div class="detail-actions">
                            <div class="actions-label">Actions</div>
                            <div class="actions-row">
                                <button id="toggleXaiBtn" class="btn btn-secondary" type="button">
                                    Show visual explanation
                                </button>

                                <a id="downloadGradcam" class="btn btn-secondary" download>
                                    Download explanation
                                </a>

                                <button id="copyDetailBtn" class="btn btn-secondary" type="button">
                                    Copy summary
                                </button>

                                <button class="btn btn-secondary" type="button" onclick="window.print()">
                                    Print
                                </button>

                                <button form="deleteForm" class="btn btn-danger-inline">
                                    Delete
                                </button>
                            </div>
                        </div>

                        <div class="notes-block">
                            <div class="actions-label">Notes</div>
                            <textarea placeholder="Add annotation (not saved)"></textarea>
                        </div>
                    </section>
                    <form id="deleteForm" method="POST"></form>
                </div>

                <div class="history-col">
                    <section class="panel history-list">
                        <div class="panel-header">
                            <h2>Analysis Log</h2>
                            <span class="panel-sub">{{ history|length }} Records</span>
                        </div>

                        <div class="history-grid">
                            {% for row in history %}
                            <div class="history-card"
                                 data-id="{{ row.id }}"
                                 data-image="{{ url_for('static', filename=row.image_path) }}"
                                 data-gradcam="{{ url_for('static', filename=row.gradcam_path) }}"
                                 data-prediction="{{ row.prediction }}"
                                 data-confidence="{{ row.confidence }}"
                                 data-time="{{ row.timestamp }}">

                                <img src="{{ url_for('static', filename=row.image_path) }}"
                                     class="history-thumb"
                                     alt="Eye scan thumbnail">

                                <div class="history-info">
                                    <div class="history-prediction">{{ row.prediction }}</div>
                                    <div class="history-confidence">{{ row.confidence }}%</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </section>

                    <section class="panel chat-panel" id="chatPanel">
                        <div class="panel-header">
                            <h2>Assistant</h2>
                            <span class="panel-sub">CataractGPT</span>
                        </div>
                        <div class="chat-body" id="chatBody">
                            <div class="chat-message bot">Select a scan to ask about it.</div>
                        </div>
                        <div class="chat-suggestions" id="chatSuggestions">
                            <button type="button" class="pill-btn">Explain confidence</button>
                            <button type="button" class="pill-btn">Should I worry?</button>
                            <button type="button" class="pill-btn">What did you see?</button>
                        </div>
                        <div class="chat-input-row">
                            <input id="chatInput" type="text" placeholder="Ask a question...">
                            <button id="chatSend" class="btn btn-primary" type="button">Send</button>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="{{ url_for('static', filename='history.js') }}"></script>
</body>
</html>
