{% set page_title = "Scan History" %}
{% set header_action = '<a href="/" class="secondary-btn">‚Üê Back</a>' %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EyeGPT ‚Äî Scan History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="{{ url_for('static', filename='history.css') }}">
</head>

<body>
    <header class="app-header">
    <!-- LEFT -->
    <div class="header-left">
        <button class="brand-btn" id="drawerToggle">
            EyeGPT
        </button>
    </div>

    <!-- CENTER -->
    <div class="header-center">
        <span class="page-title">
            {{ page_title }}
        </span>
    </div>

    <!-- RIGHT -->
    <div class="header-right">
        {{ header_action|safe }}
    </div>
</header>

<div class="history-shell">

    <main class="history-container">

        <!-- LEFT COLUMN -->
        <section class="history-left">

            <!-- SESSION INSIGHTS -->
            <div class="panel insights-panel with-footer">
                <h3>Session Insights</h3>

                <div class="insight-row">
                    <span>Total scans</span>
                    <strong>{{ history|length }}</strong>
                </div>

                <div class="insight-row">
                    <span>Normal screenings</span>
                    <strong>{{ history | selectattr("prediction","equalto","Normal") | list | length }}</strong>
                </div>

                <div class="insight-row">
                    <span>Cataract screenings</span>
                    <strong>{{ history | selectattr("prediction","equalto","Cataract") | list | length }}</strong>
                </div>

                <form action="{{ url_for('clear_history') }}" method="POST">
                    <button class="danger-btn">Clear All History</button>
                </form>
            </div>

            <div class="section-divider"></div>

            <!-- SCAN DETAILS -->
            <div class="panel detail-panel" id="detailPanel">
                <h3>Selected Scan</h3>

                <div class="detail-image-wrapper" id="detailImageWrapper">
                    <!-- Primary selected scan -->
                    <img id="detailImage" class="detail-image" alt="Selected eye scan">

                    <!-- Comparison image (hidden by default) -->
                    <div class="comparison-row">
                        <img id="compareImage" class="detail-image" alt="Comparison scan">
                    </div>

                    <!-- Empty state -->
                    <div class="detail-placeholder" id="detailPlaceholder">
                        <div class="placeholder-icon">üß†</div>
                        <p>Select a scan from history<br>to review AI screening results</p>
                    </div>
                </div>

                <div class="detail-row">
                    <span>AI screening result</span>
                    <strong id="detailPrediction">‚Äî</strong>
                </div>

                <div class="detail-row">
                    <span>Model confidence</span>
                    <strong id="detailConfidence">‚Äî</strong>
                </div>

                <div class="detail-row">
                    <span>Date & time</span>
                    <span id="detailTime">‚Äî</span>
                </div>
            </div>

        <div class="section-divider"></div>

<div class="detail-actions">

    <div class="actions-label">Actions</div>

    <div class="actions-row">
        <button id="toggleXaiBtn" class="secondary-btn">
            Show visual explanation
        </button>

        <a id="downloadGradcam" class="secondary-btn" download>
            Download explanation
        </a>

        <button class="secondary-btn" onclick="window.print()">
            Print
        </button>

        <button form="deleteForm" class="danger-btn danger-inline">
            Delete
        </button>
    </div>

</div>

        </section>

        <!-- RIGHT COLUMN -->
        <section class="history-right">
            <div class="history-grid">

                {% for row in history %}
                <div class="history-card"
                     data-id="{{ row.id }}"
                     data-image="{{ url_for('static', filename=row.image_path) }}"
                     data-gradcam="{{ url_for('static', filename=row.gradcam_path) }}"
                     data-prediction="{{ row.prediction }}"
                     data-confidence="{{ row.confidence }}"
                     data-time="{{ row.timestamp }}">

                    <img src="{{ url_for('static', filename=row.image_path) }}"
                         class="history-thumb"
                         alt="Eye scan thumbnail">

                    <div class="history-info">
                        <div class="history-prediction">{{ row.prediction }}</div>
                        <div class="history-confidence">{{ row.confidence }}%</div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </section>

    </main>
</div>

<script src="{{ url_for('static', filename='history.js') }}"></script>
</body>
</html>
