<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EyeGPT ‚Äî Scan History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="{{ url_for('static', filename='history.css') }}">
</head>

<body>
<div class="history-root">

    <header class="history-header">
        <div>
            <h1>EyeGPT</h1>
            <span class="subtitle">AI Scan History</span>
        </div>

        <div class="header-actions">
            <a href="/" class="secondary-btn">‚Üê Back</a>
        </div>
    </header>

    <main class="history-container">

        <!-- LEFT COLUMN -->
        <section class="history-left">

            <!-- SESSION INSIGHTS -->
            <div class="panel insights-panel">
                <h3>Session Insights</h3>

                <div class="insight-row">
                    <span>Total scans</span>
                    <strong>{{ history|length }}</strong>
                </div>

                <div class="insight-row">
                    <span>Normal screenings</span>
                    <strong>{{ history | selectattr("prediction","equalto","Normal") | list | length }}</strong>
                </div>

                <div class="insight-row">
                    <span>Cataract screenings</span>
                    <strong>{{ history | selectattr("prediction","equalto","Cataract") | list | length }}</strong>
                </div>

                <form action="{{ url_for('clear_history') }}" method="POST">
                    <button class="danger-btn">Clear All History</button>
                </form>
            </div>

            <!-- SCAN DETAILS -->
            <div class="panel detail-panel" id="detailPanel">
                <h3>Selected Scan</h3>

                <div class="detail-image-wrapper" id="detailImageWrapper">
                    <img id="detailImage" class="detail-image" alt="">
                    <div class="detail-placeholder" id="detailPlaceholder">
                        <div class="placeholder-icon">üß†</div>
                        <p>Select a scan from history<br>to review AI screening results</p>
                    </div>
                </div>

                <div class="detail-row">
                    <span>AI screening result</span>
                    <strong id="detailPrediction">‚Äî</strong>
                </div>

                <div class="detail-row">
                    <span>Model confidence</span>
                    <strong id="detailConfidence">‚Äî</strong>
                </div>

                <div class="detail-row">
                    <span>Date & time</span>
                    <span id="detailTime">‚Äî</span>
                </div>
            </div>


            <div class="detail-actions">

            <!-- Explainability -->
            <div class="explainability-actions">
                <button id="toggleXaiBtn" class="secondary-btn">
                    Show visual explanation (Grad-CAM)
                </button>

                <a id="downloadGradcam" class="secondary-btn" download>
                    Download visual explanation
                </a>
            </div>

            <!-- Destructive -->
            <form method="POST" id="deleteForm" class="delete-section">
                <button class="danger-btn">Delete This Scan</button>
            </form>

            <!-- Safety -->
            <p class="disclaimer">
                For educational and research use only.  
                This is not a medical diagnosis.
            </p>

            </div>

        </section>

        <!-- RIGHT COLUMN -->
        <section class="history-right">
            <div class="history-grid">

                {% for row in history %}
                <div class="history-card"
                     data-id="{{ row.id }}"
                     data-image="{{ url_for('static', filename=row.image_path) }}"
                     data-gradcam="{{ url_for('static', filename=row.gradcam_path) }}"
                     data-prediction="{{ row.prediction }}"
                     data-confidence="{{ row.confidence }}"
                     data-time="{{ row.timestamp }}">

                    <img src="{{ url_for('static', filename=row.image_path) }}"
                         class="history-thumb"
                         alt="Eye scan thumbnail">

                    <div class="history-info">
                        <div class="history-prediction">{{ row.prediction }}</div>
                        <div class="history-confidence">{{ row.confidence }}%</div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </section>

    </main>
</div>

<script src="{{ url_for('static', filename='history.js') }}"></script>
</body>
</html>
