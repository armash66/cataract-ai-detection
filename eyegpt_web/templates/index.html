<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EyeGPT â€” AI Vision System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Background video -->
<video autoplay muted loop class="bg-video">
    <source src="https://cdn.coverr.co/videos/coverr-digital-network-9719/1080p.mp4" type="video/mp4">
</video>
<div class="overlay"></div>

<!-- Scan line -->
<div id="scanLine"></div>

<div class="app">

    <!-- LEFT PANEL -->
    <div class="cyclops-panel">

        <!-- Eye Core -->
        <div class="eye-wrapper">
            <div class="eye-rays"></div>
            <div class="eye-core" id="eyeCore">
                <div class="eye-iris" id="eyeIris"></div>
            </div>
        </div>

        <h1>EyeGPT</h1>
        <p class="tagline">AI Vision Analysis System</p>

        <!-- Upload -->
        <div class="upload-box">
            <form method="POST" enctype="multipart/form-data" id="uploadForm">
                <input type="file" name="image" id="fileInput" required>
                <button type="submit">SCAN IMAGE</button>
            </form>
        </div>

        <!-- Camera Toggle -->
        <button class="ghost-btn" id="cameraToggleBtn">
            Camera (Experimental)
        </button>

        <!-- Camera Panel -->
        <div id="cameraSection" class="camera-hidden">
            <p class="warning-text">
                Camera-based screening is unreliable due to glare and exposure.
            </p>

            <label>
                <input type="checkbox" id="ackCheckbox">
                I understand the limitations
            </label>

            <button id="startCameraBtn" disabled>Activate Camera</button>

            <!-- ðŸ”§ FIX: containment wrapper prevents half-screen click -->
            <div class="camera-frame">
                <video id="video" autoplay playsinline></video>
            </div>

            <button id="captureBtn">Capture</button>
            <canvas id="canvas" hidden></canvas>
        </div>

        <!-- Preview -->
        <div id="previewSection" class="preview-box">
            <img id="previewImage">
            <button id="submitPreviewBtn">Scan Preview</button>
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="intel-panel">

        <div class="hud">
            <span>Status:</span>
            <span id="systemStatus">IDLE</span>
        </div>

        {% if result %}
        <!-- ðŸ”§ FIX: confidence must be numeric, not empty -->
        <script>
            window.lastResult = {
                prediction: "{{ result.prediction }}",
                confidence: {{ result.confidence }}
            };
        </script>
        {% endif %}

        {% if result %}
        <div class="result-card">
            <h2>Scan Result</h2>

            <div class="result-line">
                <span>{{ result.prediction }}</span>
                <span>{{ result.confidence }}%</span>
            </div>

            <!-- Confidence Ring -->
            <div class="confidence-ring">
                <svg width="120" height="120">
                    <circle cx="60" cy="60" r="50"></circle>
                    <circle cx="60" cy="60" r="50" id="confidenceCircle"></circle>
                </svg>
            </div>

            <!-- Grad-CAM -->
            <button class="ghost-btn" id="gradToggleBtn">
                Show Visual Explanation
            </button>

            <!-- ðŸ”§ FIX: isolated section for proper toggle -->
            <div id="gradcamSection" class="hidden">
                <input type="range" min="0" max="100" value="60" id="gradSlider">
                <img
                    id="gradcamImage"
                    src="{{ url_for('static', filename=gradcam) }}"
                    alt="Grad-CAM Visualization"
                >
            </div>
        </div>
        {% endif %}

        <!-- Chat -->
        <div class="chat-panel">
            <h3>EyeGPT Assistant</h3>

            <div id="aiResponse" class="chat-box">
                Upload an image to begin analysis.
            </div>

            <button class="ai-btn" onclick="askEyeGPT()">
                Explain Result
            </button>
        </div>

        <p class="disclaimer">
            Educational & research use only. Not a medical diagnostic tool.
        </p>

    </div>
</div>

<script src="{{ url_for('static', filename='camera.js') }}"></script>
<script src="{{ url_for('static', filename='ui-effects.js') }}"></script>
</body>
</html>
